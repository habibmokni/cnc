@if (cartProducts().length > 0) {
	<div class="cnc-checkout">
		<!-- ── Store Selection ───────────────────────────────────── -->
		@if (selectedStore(); as myStore) {
			<span class="store-section-label">Your Store</span>
			<cnc-store-card
				[store]="myStore"
				[selected]="true"
				[distance]="distanceMap()[myStore.id] ?? null"
				[stock]="stockMap()[myStore.id] ?? null"
				(storeSelect)="onStoreSelect($event)"
			/>

			<button
				class="change-store-toggle"
				(click)="otherStoresExpanded.set(!otherStoresExpanded())"
			>
				<span>{{ otherStoresExpanded() ? 'Hide other stores' : 'Change store' }}</span>
				<mat-icon>{{ otherStoresExpanded() ? 'expand_less' : 'expand_more' }}</mat-icon>
			</button>

			@if (otherStoresExpanded()) {
				<div class="other-stores-list">
					@for (store of otherStores(); track store.id) {
						<cnc-store-card
							[store]="store"
							[selected]="false"
							[distance]="distanceMap()[store.id] ?? null"
							[stock]="stockMap()[store.id] ?? null"
							(storeSelect)="onStoreSelect($event)"
						/>
					}
				</div>
			}
		} @else {
			<!-- No store selected yet — show all stores -->
			<span class="store-section-label">Select a store</span>
			@for (store of stores(); track store.id) {
				<cnc-store-card
					[store]="store"
					[distance]="distanceMap()[store.id] ?? null"
					[stock]="stockMap()[store.id] ?? null"
					(storeSelect)="onStoreSelect($event)"
				/>
			} @empty {
				<p class="no-stores-msg">No stores available in your area.</p>
			}
		}

		<!-- ── Unavailable Items Warning ─────────────────────────── -->
		@if (selectedStore() && !allAvailable()) {
			<div class="unavailable-banner">
				<div class="unavailable-header-row">
					<mat-icon class="warning-icon">warning</mat-icon>
					<div class="unavailable-text">
						<strong>
							{{ unavailableProducts().length }}
							{{ unavailableProducts().length === 1 ? 'item' : 'items' }}
							unavailable at this store
						</strong>
						<span>
							Remove
							{{ unavailableProducts().length === 1 ? 'it' : 'them' }}
							or try a different store.
						</span>
					</div>
				</div>

				<div class="unavailable-items-list">
					@for (product of unavailableProducts(); track product.modelNo) {
						<div class="unavailable-item-row">
							<img
								[src]="product.productImage"
								[alt]="product.productName"
								class="unavailable-item-img"
							/>
							<div class="unavailable-item-info">
								<span class="unavailable-item-name">{{ product.productName }}</span>
								<span class="unavailable-item-meta">Size {{ product.size }}</span>
							</div>
						</div>
					}
				</div>

				<button mat-flat-button class="cnc-btn" (click)="removeUnavailable()">
					Remove unavailable
				</button>
			</div>
		}

		<mat-divider />

		<!-- ── Date & Time Picker ────────────────────────────────── -->
		@if (selectedStore()) {
			<div class="datetime-section">
				<h2 class="section-title">Book a slot</h2>
				<div class="datetime-row">
					<mat-form-field appearance="outline">
						<mat-label>Pickup date</mat-label>
						<input
							matInput
							[matDatepicker]="picker"
							[matDatepickerFilter]="weekdayFilter"
							[min]="minDate"
							[max]="maxDate"
							(dateChange)="onDateChange($event.value)"
							readonly
						/>
						<mat-datepicker-toggle matIconSuffix [for]="picker" />
						<mat-datepicker #picker />
					</mat-form-field>

					<mat-form-field appearance="outline">
						<mat-label>Pickup time</mat-label>
						<input
							matInput
							[matTimepicker]="timePicker"
							[matTimepickerMin]="minTime()"
							[matTimepickerMax]="maxTime()"
							(valueChange)="onTimeChange($event)"
							readonly
						/>
						<mat-timepicker-toggle matIconSuffix [for]="timePicker" />
						<mat-timepicker #timePicker [interval]="'30m'" />
					</mat-form-field>
				</div>
			</div>
		}

		<!-- ── Summary Confirmation ──────────────────────────────── -->
		@if (isComplete()) {
			<div class="cnc-summary">
				<mat-icon class="summary-check-icon">check_circle</mat-icon>
				<div class="summary-text">
					<strong>{{ selectedStore()?.name }}</strong>
					<span>
						{{ selectedDate() | date: 'mediumDate' }} at
						{{ selectedTime() }}
					</span>
				</div>
			</div>
		}
	</div>
} @else {
	<!-- Cart is empty -->
	<div class="cnc-empty">
		<mat-icon class="empty-icon">shopping_cart</mat-icon>
		<h2>No products in cart</h2>
		<p>Please add products to use Click &amp; Collect.</p>
	</div>
}
